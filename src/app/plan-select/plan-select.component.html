<!-- NAVBAR PRINCIPAL -->
<nav class="student-navbar" *ngIf="!showBillingForm">
  <div class="navbar-container">
    <!-- Logo y título -->
    <div class="navbar-brand">
      <div class="navbar-logo">
        <img src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*A4bJG-J6YqEG_4NYhARRXg.png" alt="Galácticos Logo" />
      </div>
      <span class="navbar-title">GALACTICOS</span>
    </div>

    <!-- Dashboard title center -->
    <div class="navbar-center">
      <span class="navbar-page-title">SELECCIÓN DE PLAN</span>
    </div>

    <!-- User dropdown -->
    <div class="navbar-user" (click)="toggleUserDropdown($event)">
      <div class="user-avatar">
        <img *ngIf="studentPhotoUrl" [src]="studentPhotoUrl" alt="Foto" class="avatar-img" />
        <span *ngIf="!studentPhotoUrl" class="avatar-initials">{{ getUserInitials() }}</span>
      </div>
      <span class="user-name">{{ currentUser.nombre }}</span>
      <i class="fas fa-chevron-down dropdown-arrow" [class.rotated]="showUserDropdown"></i>
      
      <!-- Dropdown Menu -->
      <div class="user-dropdown" *ngIf="showUserDropdown" (click)="$event.stopPropagation()">
        <div class="dropdown-header">
          <div class="dropdown-avatar">
            <img *ngIf="studentPhotoUrl" [src]="studentPhotoUrl" alt="Foto" />
            <span *ngIf="!studentPhotoUrl">{{ getUserInitials() }}</span>
          </div>
          <div class="dropdown-user-info">
            <span class="dropdown-user-name">{{ currentUser.nombre }}</span>
            <span class="dropdown-user-email">{{ currentUser.email }}</span>
          </div>
        </div>
        <div class="dropdown-divider"></div>

        <button class="dropdown-item" (click)="openPasswordModal()">
          <i class="fas fa-key"></i>
          Cambiar Contraseña
        </button>
        <div class="dropdown-divider"></div>
        <button class="dropdown-item logout" (click)="confirmLogout()">
          <i class="fas fa-sign-out-alt"></i>
          Cerrar Sesión
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Click fuera para cerrar dropdown -->
<div class="dropdown-backdrop" *ngIf="showUserDropdown" (click)="closeDropdowns()"></div>

<!-- ============================================
     MODAL DE PERFIL DEL ESTUDIANTE
     ============================================ -->
<div class="modal-overlay" *ngIf="showProfileModal" (click)="closeProfileModal()">
  <div class="profile-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-user-circle"></i> Mi Perfil</h3>
      <button class="close-btn" (click)="closeProfileModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Sección de foto -->
      <div class="photo-section">
        <div class="photo-container">
          <img *ngIf="photoPreview || studentPhotoUrl" [src]="photoPreview || studentPhotoUrl" alt="Foto de perfil" class="profile-photo" />
          <div *ngIf="!photoPreview && !studentPhotoUrl" class="photo-placeholder">
            <i class="fas fa-user"></i>
          </div>
          <div class="photo-overlay" (click)="triggerFileInput()">
            <i class="fas fa-camera"></i>
          </div>
        </div>
        <input type="file" #studentFileInput accept="image/*" (change)="onStudentPhotoSelected($event)" style="display: none;" />
        <div class="photo-actions" *ngIf="selectedStudentPhoto">
          <button class="btn-upload" (click)="uploadStudentPhoto()" [disabled]="uploadingPhoto">
            <i class="fas fa-upload" *ngIf="!uploadingPhoto"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="uploadingPhoto"></i>
            {{ uploadingPhoto ? 'Subiendo...' : 'Guardar Foto' }}
          </button>
          <button class="btn-cancel-photo" (click)="cancelPhotoSelection()">
            Cancelar
          </button>
        </div>
      </div>

      <!-- Formulario de información -->
      <form class="profile-form" (ngSubmit)="updateStudentProfile()">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="studentProfile.nombre" name="nombre" placeholder="Tu nombre" />
          </div>
          <div class="form-group">
            <label>Apellido</label>
            <input type="text" [(ngModel)]="studentProfile.apellido" name="apellido" placeholder="Tu apellido" />
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="studentProfile.email" name="email" placeholder="correo@ejemplo.com" />
        </div>

        <div class="form-group">
          <label>Teléfono</label>
          <input type="tel" [(ngModel)]="studentProfile.telefono" name="telefono" placeholder="321 123 4567" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo Documento</label>
            <select [(ngModel)]="studentProfile.tipoDocumento" name="tipoDocumento">
              <option value="">Seleccionar</option>
              <option value="CC">Cédula de Ciudadanía</option>
              <option value="TI">Tarjeta de Identidad</option>
              <option value="CE">Cédula de Extranjería</option>
              <option value="PP">Pasaporte</option>
            </select>
          </div>
          <div class="form-group">
            <label>Número Documento</label>
            <input type="text" [(ngModel)]="studentProfile.numeroDocumento" name="numeroDocumento" placeholder="12345678" />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeProfileModal()">Cancelar</button>
          <button type="submit" class="btn-primary" [disabled]="updatingProfile">
            <i class="fas fa-save" *ngIf="!updatingProfile"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="updatingProfile"></i>
            {{ updatingProfile ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL DE CAMBIO DE CONTRASEÑA
     ============================================ -->
<div class="modal-overlay" *ngIf="showPasswordModal" (click)="closePasswordModal()">
  <div class="password-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-key"></i> Cambiar Contraseña</h3>
      <button class="close-btn" (click)="closePasswordModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <form class="password-form" (ngSubmit)="changeStudentPassword()">
        <div class="form-group password-group">
          <label>Contraseña Actual</label>
          <div class="password-input-wrapper">
            <input [type]="showCurrentPassword ? 'text' : 'password'" 
                   [(ngModel)]="passwordData.currentPassword" 
                   name="currentPassword" 
                   placeholder="••••••••" />
            <button type="button" class="btn-eye" (click)="showCurrentPassword = !showCurrentPassword">
              <i class="fas" [class.fa-eye]="!showCurrentPassword" [class.fa-eye-slash]="showCurrentPassword"></i>
            </button>
          </div>
        </div>

        <div class="form-group password-group">
          <label>Nueva Contraseña</label>
          <div class="password-input-wrapper">
            <input [type]="showNewPassword ? 'text' : 'password'" 
                   [(ngModel)]="passwordData.newPassword" 
                   name="newPassword" 
                   placeholder="••••••••" />
            <button type="button" class="btn-eye" (click)="showNewPassword = !showNewPassword">
              <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
            </button>
          </div>
        </div>

        <div class="form-group password-group">
          <label>Confirmar Nueva Contraseña</label>
          <div class="password-input-wrapper">
            <input [type]="showConfirmPassword ? 'text' : 'password'" 
                   [(ngModel)]="passwordData.confirmPassword" 
                   name="confirmPassword" 
                   placeholder="••••••••" />
            <button type="button" class="btn-eye" (click)="showConfirmPassword = !showConfirmPassword">
              <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
            </button>
          </div>
        </div>

        <div class="password-error" *ngIf="passwordError">
          <i class="fas fa-exclamation-circle"></i>
          {{ passwordError }}
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closePasswordModal()">Cancelar</button>
          <button type="submit" class="btn-primary" [disabled]="changingPassword">
            <i class="fas fa-check" *ngIf="!changingPassword"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="changingPassword"></i>
            {{ changingPassword ? 'Cambiando...' : 'Cambiar Contraseña' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================================
     FORMULARIO DE FACTURACIÓN - Estilo SmartFit
     ============================================ -->
<div class="billing-page" *ngIf="showBillingForm && selectedPlan">
  
  <!-- Header del formulario -->
  <header class="billing-header">
    <div class="header-left">
      <div class="logo-img">
        <img src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*A4bJG-J6YqEG_4NYhARRXg.png" alt="Galácticos Logo" class="logo-image" />
      </div>
      <span class="simple-text logo-normal">GALACTICOS</span>
    </div>
    <button class="back-btn" (click)="cancelBillingForm()">
      <i class="fas fa-arrow-left"></i>
      Volver
    </button>
  </header>

  <div class="billing-container">
    
    <!-- Columna izquierda: Formulario -->
    <div class="billing-form-section">
      <h2 class="billing-title">Completa tus datos para continuar</h2>

      <div class="form-group">
        <label class="form-label">Tipo de Identificación</label>
        <select class="form-select" [(ngModel)]="billingData.tipoDocumento">
          <option value="" disabled selected>Selecciona un tipo</option>
          <option *ngFor="let tipo of tiposDocumento" [value]="tipo.value">{{ tipo.label }}</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">Documento de Identificación</label>
        <input type="text" class="form-input" placeholder="Ingresa tu documento" [(ngModel)]="billingData.documento">
        <span class="form-hint" *ngIf="!billingData.documento">Debe ser completado</span>
      </div>

      <div class="form-group">
        <label class="form-label required">Nombre Completo</label>
        <input type="text" class="form-input" placeholder="Ingresa tu nombre completo" [(ngModel)]="billingData.nombreCompleto">
      </div>

      <div class="form-group">
        <label class="form-label required">E-mail</label>
        <input type="email" class="form-input" placeholder="ej: correo@ejemplo.com" [(ngModel)]="billingData.email">
      </div>

      <div class="form-group">
        <label class="form-label required">Número de Celular</label>
        <div class="phone-input">
          <span class="phone-prefix">
            <img src="https://flagcdn.com/w20/co.png" alt="CO" class="flag-icon">
            +57
          </span>
          <input type="tel" class="form-input phone-number" placeholder="321 1234567" [(ngModel)]="billingData.celular">
        </div>
      </div>

      <!-- Error message -->
      <div class="billing-error" *ngIf="paymentError">
        <i class="fas fa-exclamation-circle"></i>
        {{ paymentError }}
      </div>

      <button class="btn-submit" (click)="proceedToPayment()" [disabled]="!isFormValid()">
        Continuar al pago
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>

    <!-- Columna derecha: Detalles de la compra -->
    <div class="billing-summary-section">
      <h3 class="summary-title">Detalles de la compra</h3>

      <!-- Plan seleccionado -->
      <div class="summary-plan-card">
        <div class="plan-badge">
          <img src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*A4bJG-J6YqEG_4NYhARRXg.png" alt="Plan" class="plan-badge-img">
          <div class="plan-badge-info">
            <span class="plan-badge-name">Plan {{ selectedPlan.months }} mes{{ selectedPlan.months > 1 ? 'es' : '' }}</span>
            <span class="plan-badge-desc">Acceso completo a entrenamientos</span>
          </div>
        </div>
      </div>

      <!-- Desglose de pagos -->
      <div class="summary-breakdown">
        <div class="summary-row" *ngFor="let i of [].constructor(selectedPlan.months); let idx = index">
          <div class="row-label">
            <span class="row-title">{{ idx + 1 }}{{ idx === 0 ? 'ra' : 'da' }} Mensualidad</span>
          </div>
          <span class="row-value">${{ (selectedPlan.price / selectedPlan.months) | number:'1.0-0' }}</span>
        </div>

        <div class="summary-row">
          <span class="row-label">Inscripción</span>
          <span class="row-value">$0</span>
        </div>

        <div class="summary-row total">
          <span class="row-label">Total</span>
          <span class="row-value">${{ selectedPlan.price | number:'1.0-0' }}</span>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal de Confirmación de Logout -->
<div class="modal-overlay" *ngIf="showLogoutModal" (click)="cancelLogout()">
  <div class="modal-container logout-modal" (click)="$event.stopPropagation()">
    <div class="modal-icon">
      <i class="fas fa-sign-out-alt"></i>
    </div>
    <h3 class="modal-title">¿Cerrar Sesión?</h3>
    <p class="modal-message">¿Estás seguro de que deseas cerrar tu sesión? Tendrás que volver a iniciar sesión para acceder al sistema.</p>
    <div class="modal-actions">
      <button class="btn-modal btn-cancel" (click)="cancelLogout()">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button class="btn-modal btn-confirm" (click)="logout()">
        <i class="fas fa-check"></i>
        Sí, Cerrar Sesión
      </button>
    </div>
  </div>
</div>

<!-- Modal de Pago con Wompi - Rediseñado -->
<div class="modal-overlay" *ngIf="showPaymentModal" (click)="cancelPayment()">
  <div class="payment-modal-new" (click)="$event.stopPropagation()">
    
    <!-- Header con logo -->
    <div class="payment-modal-header">
      <div class="payment-logo">
        <img src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*A4bJG-J6YqEG_4NYhARRXg.png" alt="Galácticos" class="payment-logo-img">
      </div>
      <h2 class="payment-modal-title">Resumen de tu compra</h2>
      <button class="payment-close-btn" (click)="cancelPayment()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Contenido -->
    <div class="payment-modal-body" *ngIf="selectedPlan">
      
      <!-- Plan seleccionado -->
      <div class="selected-plan-box">
        <div class="plan-info-left">
          <span class="plan-label">Plan seleccionado</span>
          <span class="plan-name-big">{{ selectedPlan.months }} mes{{ selectedPlan.months > 1 ? 'es' : '' }}</span>
          <span class="plan-desc">Acceso completo a entrenamientos</span>
        </div>
        <div class="plan-price-right">
          <span class="price-amount">${{ selectedPlan.price | number:'1.0-0' }}</span>
          <span class="price-currency">COP</span>
        </div>
      </div>

      <!-- Métodos de pago -->
      <div class="payment-methods-box">
        <span class="methods-label">Paga de forma segura con:</span>
        <div class="methods-grid">
          <div class="method-item">
            <i class="fab fa-cc-visa" style="color: #1A1F71; font-size: 28px;"></i>
          </div>
          <div class="method-item">
            <i class="fab fa-cc-mastercard" style="color: #EB001B; font-size: 28px;"></i>
          </div>
          <div class="method-item">
            <span style="font-weight: 700; color: #00A651; font-size: 14px;">PSE</span>
          </div>
          <div class="method-item nequi-method">
            <span style="font-weight: 700; color: #E91E63; font-size: 14px;">Nequi</span>
          </div>
        </div>
      </div>

      <!-- Error message -->
      <div class="payment-error" *ngIf="paymentError">
        <i class="fas fa-exclamation-circle"></i>
        {{ paymentError }}
      </div>

    </div>

    <!-- Footer con botones -->
    <div class="payment-modal-footer">
      <button class="btn-back" (click)="cancelPayment()" [disabled]="isProcessing">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
      <button class="btn-pay-now" (click)="processPaymentWithLink()" [disabled]="isProcessing">
        <span *ngIf="!isProcessing">
          <i class="fas fa-lock"></i>
          Pagar ${{ selectedPlan?.price | number:'1.0-0' }} COP
        </span>
        <span *ngIf="isProcessing" class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
          Procesando...
        </span>
      </button>
    </div>

    <!-- Seguridad -->
    <div class="payment-secure-badge">
      <i class="fas fa-shield-alt"></i>
      <span>Pago 100% seguro con Wompi</span>
    </div>

  </div>
</div>

<!-- PAGE -->
<div class="plans-page" *ngIf="!showBillingForm">

  <!-- HERO -->
  <section class="plans-hero">
    <h1 class="plans-title">
      Selecciona tu <span>Plan de Entrenamiento</span>
    </h1>

    <p class="plans-subtitle">
      Elige el plan que mejor se adapte a tus necesidades
    </p>
  </section>

  <!-- PLANS -->
  <section class="plans-grid">
    <article
      class="plan-card"
      *ngFor="let p of plans"
      [class.popular]="p.label"
      [class.selected]="selectedPlan?.months === p.months"
      (click)="selectPlan(p)"
    >
      <span class="popular-chip" *ngIf="p.label">{{ p.label }}</span>

      <!-- Radio button visual -->
      <div class="plan-radio">
        <div class="radio-circle" [class.active]="selectedPlan?.months === p.months">
          <div class="radio-dot" *ngIf="selectedPlan?.months === p.months"></div>
        </div>
      </div>

      <!-- Logo del club -->
      <div class="plan-logo">
        <img src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*A4bJG-J6YqEG_4NYhARRXg.png" alt="Galácticos" class="plan-logo-img">
      </div>

      <header class="plan-header">
        <h3 class="plan-title">
          Plan {{ p.months }} mes{{ p.months > 1 ? 'es' : '' }}
        </h3>
        <span class="plan-subtitle">Acceso completo a entrenamientos</span>
      </header>

      <div class="plan-body">
        <div class="plan-price">
          <span class="currency">$</span>
          <span class="amount">{{ p.price | number:'1.0-0' }}</span>
          <span class="period">/total</span>
        </div>

        <ul class="plan-features">
          <li *ngFor="let f of getFeatures(p)">
            <span class="check-icon"><i class="fas fa-check"></i></span> {{ f }}
          </li>
        </ul>
      </div>
    </article>
  </section>

  <!-- Botón de acción -->
  <section class="plans-actions">
    <button class="btn-continue-single" (click)="elegirPlan(selectedPlan)" [disabled]="!selectedPlan">
      Continuar al pago
      <i class="fas fa-arrow-right"></i>
    </button>
  </section>

</div>
